version: '3.1'
services:
  jenkins-coordinator:
    container_name: jenkins
    ports:
      - '8080:8080'
      - '50000:50000'
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './coordinator/casc_config:/var/jenkins_home/casc_configs'
    image: dev/jenkins
    build:
      context: ./coordinator/
      dockerfile: Dockerfile
  jenkins-worker:
    container_name: jenkins-worker
    restart: always
    environment:
      - 'JENKINS_URL=http://jenkins:8080'
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
    depends_on:
      - jenkins-coordinator
    image: dev/jenkins-dotnetcore-agent
    build:
      context: ./worker/
      dockerfile: Dockerfile
  localtunnel:
    image: dev/localtunnel
    container_name: localtunnel
    build:
      dockerfile: Dockerfile
      context: ./localtunnel
    restart: on-failure
    command: '--local-host jenkins -h https://serverless.social --port 8080'
  ngrok:
    container_name: ngrok
    ports:
      - '4040'
    links:
      - jenkins-coordinator
    image: wernight/ngrok
    command: 'sh -c "ngrok authtoken ${NGROK_AUTH} && ngrok http jenkins:8080"'
